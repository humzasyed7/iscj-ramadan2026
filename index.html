<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Support our fundraising campaign - Donate now!">
    <title>Donation Campaign - Non-Profit Organization</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="App">

        <header class="header" role="banner">
            <div class="logo-container">
                <a href="https://www.iscj.org/">
                    <img src="images/iscj-white.png" alt="ISCJ Logo" class="header-logo">
                </a>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="donation-flex-row">
                <section class="content-block mission-section">
                    <h2>Consistency is beloved to Allah</h2>
                    <p class="text-block">
                        "...The most beloved deed to Allah is the most consistent, even if it is little" (Sahih al-Bukhari 6464)
                    </p>
                </section>
                <section class="commitment-panel" id="commitment-panel">
                    <h2 class="commitment-title">Automate your Rewards</h2>
                    <div class="commitment-toggle-row">
                        <button class="commitment-toggle" data-freq="D">Daily</button>
                        <button class="commitment-toggle" data-freq="W">Weekly</button>
                        <button class="commitment-toggle active" data-freq="M">Monthly</button>
                    </div>
                    <div class="commitment-amounts-row" id="commitment-amounts">
                        <!-- Dynamically populated -->
                    </div>
                    <input type="number" class="commitment-custom-input" id="commitment-custom-input" placeholder="$0.00" min="0" step="0.01" aria-label="Custom donation amount">
                    <button class="commitment-checkout-btn" id="commitment-checkout" disabled>Select an amount</button>
                </section>
            </div>


            <!-- Donut Charts Section -->
            <section class="donations-section donut-charts-section">
                <h2>Your Donations Make ISCJ Possible</h2>
                <div class="donut-charts-container">
                    <!-- Revenue Chart Only -->
                    <div class="donut-chart-wrapper">
                        <div class="donut-chart" id="revenue-chart">
                            <svg viewBox="0 0 200 200" class="donut-svg">
                                <g class="donut-segments" transform="rotate(-90 100 100)">
                                    <!-- Segments will be rendered via JS -->
                                </g>
                            </svg>
                            <div class="donut-center">
                                <span class="donut-total">$1.6M</span>
                                <span class="donut-label">Revenue</span>
                            </div>
                        </div>
                        <div class="donut-legend" id="revenue-legend">
                            <!-- Legend items rendered via JS -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Other Ways to Donate Section -->
            <section class="donations-section">
                <h2>Other Ways to Donate</h2>
                <div class="alternative-methods-row" id="alternative-methods">
                    <!-- Dynamically populated from donation-methods.json -->
                </div>
            </section>
        </main>

        <!-- Zelle QR Modal -->
        <div id="zelle-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <button class="modal-close" aria-label="Close modal">&times;</button>
                <img src="images/zelle_qr.png" alt="Zelle QR Code" class="modal-qr-code">
                <p class="modal-text">Donate via Zelle to accounting@iscj.org</p>
            </div>
        </div>

        
    </div>
</body>
    <script>
        (function(){
            const PAYPAL_BUSINESS = 'iscjlit@iscj.org';

            function buildPaypalUrl(amount, itemName = 'Donation', recurring = false, interval = 1, period = 'M') {
                const base = 'https://www.paypal.com/cgi-bin/webscr';
                const params = new URLSearchParams();

                if (recurring) {
                    // Subscriptions: use _xclick-subscriptions with a3, p3, t3
                    params.set('cmd', '_xclick-subscriptions');
                    params.set('business', PAYPAL_BUSINESS);
                    params.set('a3', Number(amount).toFixed(2));
                    params.set('p3', String(interval));
                    params.set('t3', period); // D,W,M,Y
                    params.set('src', '1'); // make payments recur
                    params.set('sra', '1'); // reattempt on failure
                    params.set('item_name', itemName);
                    params.set('currency_code', 'USD');
                } else {
                    // One-time donation
                    params.set('cmd', '_donations');
                    params.set('business', PAYPAL_BUSINESS);
                    params.set('amount', Number(amount).toFixed(2));
                    params.set('currency_code', 'USD');
                    params.set('item_name', itemName);
                }

                return base + '?' + params.toString();
            }

            // ── Consistency & Commitment Panel ──
            (function commitmentPanel() {
                const presets = {
                    D: [1, 5, 8],
                    W: [5, 15, 25],
                    M: [10, 25, 50]
                };
                const freqLabels = { D: 'Daily', W: 'Weekly', M: 'Monthly' };

                let selectedFreq = 'M';
                let selectedAmt = null;

                const toggleBtns = document.querySelectorAll('.commitment-toggle');
                const amountsRow = document.getElementById('commitment-amounts');
                const checkoutBtn = document.getElementById('commitment-checkout');
                const customInput = document.getElementById('commitment-custom-input');

                function renderAmounts(freq) {
                    amountsRow.innerHTML = '';
                    presets[freq].forEach(amt => {
                        const btn = document.createElement('button');
                        btn.className = 'commitment-amount-btn';
                        btn.textContent = '$' + amt;
                        btn.dataset.amount = amt;
                        btn.addEventListener('click', () => {
                            selectedAmt = amt;
                            customInput.value = '';
                            document.querySelectorAll('.commitment-amount-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            checkoutBtn.disabled = false;
                            checkoutBtn.textContent = 'Checkout';
                        });
                        amountsRow.appendChild(btn);
                    });
                }

                toggleBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        toggleBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedFreq = btn.dataset.freq;
                        selectedAmt = null;
                        customInput.value = '';
                        checkoutBtn.disabled = true;
                        checkoutBtn.textContent = 'Select an amount';
                        renderAmounts(selectedFreq);
                    });
                });

                customInput.addEventListener('focus', () => {
                    document.querySelectorAll('.commitment-amount-btn').forEach(b => b.classList.remove('active'));
                });

                customInput.addEventListener('input', () => {
                    const value = customInput.value.trim();
                    if (value && !isNaN(value) && parseFloat(value) > 0) {
                        selectedAmt = null;
                        document.querySelectorAll('.commitment-amount-btn').forEach(b => b.classList.remove('active'));
                        checkoutBtn.disabled = false;
                        checkoutBtn.textContent = 'Checkout';
                    } else {
                        if (selectedAmt === null) {
                            checkoutBtn.disabled = true;
                            checkoutBtn.textContent = 'Select an amount';
                        }
                    }
                });

                checkoutBtn.addEventListener('click', () => {
                    const customValue = customInput.value.trim();
                    let amount = selectedAmt;
                    
                    if (customValue && !isNaN(customValue) && parseFloat(customValue) > 0) {
                        amount = parseFloat(customValue);
                    }
                    
                    if (!amount) return;
                    const itemName = 'Ramadan ' + freqLabels[selectedFreq] + ' Donation';
                    const url = buildPaypalUrl(amount, itemName, true, 1, selectedFreq);
                    window.open(url, '_blank');
                });

                // Initial render (Monthly)
                renderAmounts(selectedFreq);
            })();

            // ── Alternative Methods Section ──
            (async function loadAlternativeMethods() {
                try {
                    const response = await fetch('donation-methods.json');
                    if (!response.ok) throw new Error('Failed to load donation methods');
                    const data = await response.json();
                    const container = document.getElementById('alternative-methods');
                    const zelleModal = document.getElementById('zelle-modal');
                    const modalClose = document.querySelector('.modal-close');
                    
                    if (data.alternative_methods && Array.isArray(data.alternative_methods)) {
                        data.alternative_methods.forEach(method => {
                            const img = document.createElement('img');
                            img.src = method.icon;
                            img.alt = method.name;
                            
                            if (method.type === 'modal') {
                                // Create button for modal type
                                const button = document.createElement('button');
                                button.className = 'alternative-method-link';
                                button.title = method.name;
                                button.setAttribute('aria-label', `Donate via ${method.name}`);
                                
                                button.appendChild(img);
                                button.addEventListener('click', () => {
                                    zelleModal.style.display = 'flex';
                                });
                                container.appendChild(button);
                            } else {
                                // Create link for regular methods
                                const link = document.createElement('a');
                                link.href = method.link;
                                link.target = '_blank';
                                link.rel = 'noopener noreferrer';
                                link.className = 'alternative-method-link';
                                link.title = method.name;
                                link.setAttribute('aria-label', `Donate via ${method.name}`);
                                
                                link.appendChild(img);
                                container.appendChild(link);
                            }
                        });
                    }
                    
                    // Modal close handlers
                    modalClose.addEventListener('click', () => {
                        zelleModal.style.display = 'none';
                    });
                    
                    zelleModal.addEventListener('click', (e) => {
                        if (e.target === zelleModal) {
                            zelleModal.style.display = 'none';
                        }
                    });
                    
                } catch (err) {
                    console.warn('Failed to load alternative donation methods:', err);
                }
            })();

            // ── Donut Charts Animation ──
            (function initDonutCharts() {
                const revenueData = [
                    { name: 'Donations', percent: 47.6, color: '#D4AF37' },
                    { name: 'Membership', percent: 21.4, color: '#1E3A8A' },
                    { name: 'Tuition', percent: 20.6, color: '#3B5998' },
                    { name: 'Income', percent: 10.3, color: '#5B7BC5' }
                ];

                function createDonutChart(chartId, legendId, data) {
                    const chartEl = document.getElementById(chartId);
                    const legendEl = document.getElementById(legendId);
                    if (!chartEl || !legendEl) return;

                    const svg = chartEl.querySelector('.donut-segments');
                    const radius = 70;
                    const circumference = 2 * Math.PI * radius;
                    
                    let currentOffset = 0;
                    const segments = [];

                    // Sort data by percentage descending for better visual
                    const sortedData = [...data].sort((a, b) => b.percent - a.percent);

                    sortedData.forEach((item, index) => {
                        const segmentLength = (item.percent / 100) * circumference;
                        const dashArray = `${segmentLength} ${circumference - segmentLength}`;
                        
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', '100');
                        circle.setAttribute('cy', '100');
                        circle.setAttribute('r', radius);
                        circle.setAttribute('class', 'donut-segment');
                        circle.setAttribute('stroke', item.color);
                        circle.setAttribute('data-index', index);
                        circle.style.strokeDasharray = `0 ${circumference}`;
                        circle.style.strokeDashoffset = -currentOffset;
                        circle.style.setProperty('--circumference', circumference);
                        circle.style.setProperty('--final-dasharray', dashArray);
                        
                        segments.push({
                            element: circle,
                            targetDasharray: dashArray,
                            offset: currentOffset,
                            item: item
                        });

                        svg.appendChild(circle);
                        currentOffset += segmentLength;

                        // Create legend item
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.dataset.index = index;
                        legendItem.innerHTML = `
                            <span class="legend-color" style="background-color: ${item.color}"></span>
                            <span class="legend-text">
                                <span class="legend-name">${item.name}</span>
                                <span class="legend-percent">${item.percent}%</span>
                            </span>
                        `;
                        legendEl.appendChild(legendItem);

                        // Hover interactions
                        const highlight = () => {
                            segments.forEach((s, i) => {
                                s.element.classList.toggle('highlighted', i === index);
                            });
                            legendEl.querySelectorAll('.legend-item').forEach((li, i) => {
                                li.classList.toggle('highlighted', i === index);
                            });
                        };

                        const unhighlight = () => {
                            segments.forEach(s => s.element.classList.remove('highlighted'));
                            legendEl.querySelectorAll('.legend-item').forEach(li => li.classList.remove('highlighted'));
                        };

                        circle.addEventListener('mouseenter', highlight);
                        circle.addEventListener('mouseleave', unhighlight);
                        legendItem.addEventListener('mouseenter', highlight);
                        legendItem.addEventListener('mouseleave', unhighlight);
                    });

                    // Animate segments on load with staggered timing
                    const animateSegments = () => {
                        segments.forEach((seg, index) => {
                            setTimeout(() => {
                                seg.element.style.transition = 'stroke-dasharray 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                                seg.element.style.strokeDasharray = seg.targetDasharray;
                            }, index * 150);
                        });
                    };

                    // Use Intersection Observer to trigger animation when visible
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                animateSegments();
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.3 });

                    observer.observe(chartEl);
                }

                // Initialize only the revenue chart
                createDonutChart('revenue-chart', 'revenue-legend', revenueData);
            })();

        })();
    </script>
</html>
